generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User roles in the platform
enum Role {
  CONTRIBUTOR
  SCOUT
  ADMIN
}

// Academic/professional roles
enum UserRole {
  PHD_STUDENT
  POSTDOC
  PROFESSOR
  INDUSTRY_RESEARCHER
  INDEPENDENT_RESEARCHER
  OTHER
}

// Scout application workflow status
enum ScoutApplicationStatus {
  NOT_APPLIED
  PENDING
  APPROVED
  REJECTED
}

// Research submission pipeline stages
enum SubmissionStatus {
  PENDING_RESEARCH
  VALIDATING
  PITCHED_MATCHMAKING
  MATCH_MADE
  REJECTED
}

// Career stage of researcher
enum CareerStage {
  UNDERGRAD_STUDENT
  PHD_STUDENT
  POSTDOC
  PROFESSOR
  INDUSTRY_RESEARCHER
  INDEPENDENT_RESEARCHER
  OTHER
}

// Research maturity level
enum ResearchStage {
  EARLY_CONCEPT
  ACTIVE_RESEARCH
  HAS_RESULTS
  PUBLISHED
}

// Funding status of research
enum FundingStatus {
  NOT_SEEKING
  SEEKING_SEED
  SEEKING_SERIES_A
  GRANT_FUNDED
  INDUSTRY_FUNDED
  VC_BACKED
}

// How the scout found this lead
enum SubmissionSource {
  CONFERENCE
  ACADEMIC_PAPER
  LINKEDIN
  PERSONAL_CONNECTION
  LAB_VISIT
  OTHER
}

// Scout's relationship to researcher
enum Relationship {
  LAB_MATE
  CLASSMATE
  COLLEAGUE
  NO_RELATIONSHIP
  OTHER
}

// Core user model - handles authentication and profile
model User {
  // Core Identity
  id            String  @id @default(cuid())
  email         String  @unique
  password      String
  fullName      String
  firstName     String
  lastName      String
  preferredName String?
  role          Role    @default(CONTRIBUTOR)

  // Authentication
  emailVerified       DateTime?
  verificationToken   String?   @unique
  verificationExpires DateTime?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Scout Profile (populated via scout application)
  university             String?
  department             String?
  linkedinUrl            String?
  userRole               UserRole?
  userRoleOther          String?
  researchAreas          String?
  whyScout               String?
  howSourceLeads         String?
  scoutApplicationStatus ScoutApplicationStatus @default(NOT_APPLIED)
  scoutApplicationDate   DateTime?

  // Profile Settings
  bio                String?
  personalWebsite    String?
  additionalLinks    Json?
  profilePictureUrl  String?

  // Account Security
  twoFactorEnabled   Boolean  @default(false)
  twoFactorSecret    String?

  // Stats
  totalSubmissions    Int @default(0)
  pendingSubmissions  Int @default(0)
  approvedSubmissions Int @default(0)

  // Relations
  submissions    ResearchSubmission[]
  comments       SubmissionComment[]
  passwordResets PasswordReset[]

  @@index([email])
  @@index([role])
  @@index([scoutApplicationStatus])
  @@index([createdAt])
}

// Research lead submission - 3-step form
model ResearchSubmission {
  // Core
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status      SubmissionStatus @default(PENDING_RESEARCH)
  isDraft     Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  submittedAt DateTime?

  // Step 1 - Research Summary
  researchTopic         String?
  researchDescription   String?
  researcherName        String?
  researcherEmail       String?
  researcherInstitution String?
  researcherDepartment  String?

  // Step 2 - Additional Details
  researcherCareerStage      CareerStage?
  researcherCareerStageOther String?
  researcherLinkedin         String?
  researchStage            ResearchStage?
  fundingStatus            FundingStatus?
  keyPublications          String?
  potentialApplications    String?
  supportingLinks          Json?             @default("[]")
  submissionSource         SubmissionSource?
  relationshipToResearcher Relationship?
  researcherAwareness      Boolean           @default(false)

  // Step 3 - Scout Pitch
  whyInteresting String?

  // System
  isDuplicate Boolean @default(false)
  duplicateOf String?

  // Relations
  comments SubmissionComment[]

  @@index([userId])
  @@index([status])
  @@index([isDraft])
  @@index([researcherEmail])
  @@index([createdAt])
  @@index([submittedAt])
}

// Comments on research submissions
model SubmissionComment {
  id           String             @id @default(cuid())
  submissionId String
  submission   ResearchSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  userId       String
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  content      String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([submissionId])
  @@index([userId])
}

// Password reset tokens
model PasswordReset {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// Global system settings
model SystemSettings {
  id                       String   @id @default(cuid())
  enableEmailNotifications Boolean  @default(true)
  enableInAppNotifications Boolean  @default(true)
  updatedAt                DateTime @updatedAt
}
